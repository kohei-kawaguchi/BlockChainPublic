---
title: "Describe Data"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(BlockChainPublic)
library(foreach)
library(magrittr)
library(doParallel)
library(ggpubr)
library(kableExtra)
```


```{r}
# --------- #
# load data
# --------- #
currency_algo_date <- readRDS(file = "../output/currency_algo_date.rds")
currency_algo_date_top <- readRDS(file = here::here("output/currency_algo_date_top.rds"))
currency_algo_date_scrypt <- readRDS(file = here::here("output/currency_algo_date_scrypt.rds"))
asic_spec_top <- readRDS(file = "../output/asic_spec_top.rds")
asic_spec_scrypt <- readRDS(file = "../output/asic_spec_scrypt.rds")
gpu_spec <- readRDS(file = "../output/gpu_spec.rds")
currency_week_hashrate <- readRDS(file = "../cleaned/currency_week_hashrate.rds")
```

# Currency-algo-date-level data {.tabset}

## Summary table {.tabset}

```{r}
# categorical variables
currency_algo_date %>%
  dplyr::select_if(~ !is.numeric(.)) %>%
  gtsummary::tbl_summary(
    data = .
  )

# numerical variables
currency_algo_date %>%
  dplyr::select_if(is.numeric) %>%
  psych::describe(
    fast = TRUE,
    quant = c(0.25, 0.5, 0.75)
  ) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()
  
```


## Winning rate {.tabset}

```{r, results = "asis"}
# make time series 
p <- currency_algo_date %>%
  dplyr::mutate(log_winning_rate = log(winning_rate)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = date,
        y = log_winning_rate,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Log of winning rate",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```


## Hash rate {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_algo_date %>%
  dplyr::mutate(log_hash_rate = log(hash_rate)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = date,
        y = log_hash_rate,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Log of hash rate (H/s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Block time {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_algo_date %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = date,
        y = block_time,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Block time (s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```



## Hash rate standard deviation {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_algo_date %>%
  dplyr::mutate(log_hash_rate_sd = log(hash_rate_sd)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = date,
        y = log_hash_rate_sd,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Log of hash rate s.d. (H/s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Block time standard deviation {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_algo_date %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = date,
        y = block_time_sd,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Block time s.d. (s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Transaction volume {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_algo_date %>%
  dplyr::mutate(log_volume = log(volume)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = date,
        y = log_volume,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Log of transaction volume (Billion USD)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Exchgange rate in USD {.tabset}

```{r, results = "asis"}
# make time series 
p <- currency_algo_date %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ dplyr::distinct(
      .,
      currency,
      date,
      .keep_all = TRUE
    ) %>%
    ggplot(
      aes(
        x = date,
        y = rate_quoteusd,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Exchange rate (USD)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "none"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Reward in USD {.tabset}

```{r, results = "asis"}
# make time series 
p <- currency_algo_date %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ dplyr::distinct(
      .,
      currency,
      date,
      .keep_all = TRUE
    ) %>%
    ggplot(
      aes(
        x = date,
        y = reward_quoteusd,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Date",
        y = "Reward (USD)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "none"
      )
  )
# draw time series 
currency_list <-
  unique(currency_algo_date$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

# Currency-algo-week-level data {.tabset}

## Summary table {.tabset}

```{r}
# categorical variables
currency_week_hashrate %>%
  dplyr::select_if(~ !is.numeric(.)) %>%
  gtsummary::tbl_summary(
    data = .
  )

# numerical variables
currency_week_hashrate %>%
  dplyr::select_if(is.numeric) %>%
  psych::describe(
    fast = TRUE,
    quant = c(0.25, 0.5, 0.75)
  ) %>%
  kableExtra::kbl() %>%
  kableExtra::kable_styling()
  
```


## Winning rate {.tabset}

```{r, results = "asis"}
# make time series 
p <- currency_week_hashrate %>%
  dplyr::mutate(log_winning_rate = log(winning_rate)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = week,
        y = log_winning_rate,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Week",
        y = "Log of winning rate",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_week_hashrate$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```


## Hash rate {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_week_hashrate %>%
  dplyr::mutate(log_hash_rate = log(hash_rate)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = week,
        y = log_hash_rate,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Week",
        y = "Log of hash rate (H/s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_week_hashrate$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Block time {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_week_hashrate %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = week,
        y = block_time,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Week",
        y = "Block time (s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_week_hashrate$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```



## Hash rate standard deviation {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_week_hashrate %>%
  dplyr::mutate(log_hash_rate_sd = log(hash_rate_sd)) %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = week,
        y = log_hash_rate_sd,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Week",
        y = "Log of hash rate s.d. (H/s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_week_hashrate$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Block time standard deviation {.tabset}

```{r, results = "asis"}
# make time series
p <- currency_week_hashrate %>%
  dplyr::group_split(currency) %>%
  purrr::map(
    .,
    ~ ggplot(
      .,
      aes(
        x = week,
        y = block_time_sd,
        colour = algo
        )
      ) +
      geom_point() +
      labs(
        x = "Week",
        y = "Block time s.d. (s)",
        title = .$currency[1]
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
# draw time series 
currency_list <-
  unique(currency_week_hashrate$currency)
for (i in 1:length(p)) {
  cat("### ", currency_list[i], "\n")
  print(p[i])
  cat("\n")
}
```


# Machine-level data {.tabset}

## GPU {.tabset}
```{r}
# average gpu hash power
gpu_date <-
  gpu_spec %>%
  tidyr::expand(
    model,
    date = seq(min(release), to = as.Date("2020-12-31"), by = 1)
  ) %>%
  dplyr::left_join(
    gpu_spec,
    by = c("model", "date" = "release")
  ) %>%
  dplyr::group_by(model) %>%
  tidyr::fill(dplyr::everything(), .direction = "down") %>%
  dplyr::ungroup()
```

```{r}
# plot number of available gpu machines
gpu_date %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(number = sum(!is.na(hash_rate_spec))) %>%
  dplyr::ungroup() %>%
  ggpubr::ggline(
    x = "date",
    y = "number",
    ylab = "number of available models",
    plot_type = "l"
  )
```

```{r}
# plot hash_rate_spec
gpu_date %>%
  dplyr::group_by(date) %>%
  dplyr::summarise(
    min = min(hash_rate_spec, na.rm = TRUE),
    median = quantile(hash_rate_spec, 0.5, na.rm = TRUE),
    max = max(hash_rate_spec, na.rm = TRUE)
  ) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_longer(cols = c(min, median, max)) %>%
  ggplot(
    aes(
      x = date,
      y = value,
      colour = name
    )
  ) +
  geom_line() +
  labs(
    x = "Date",
    y = "Hashrate (h/s) for ethash"
  ) +
  scale_colour_viridis_d() +
  theme_classic() +
  theme(
    legend.position = "bottom"
  )
```



## ASIC {.tabset}

### top currencies {.tabset}
```{r}
# average asic hash power for top currencies
asic_algo_date_top <-
  asic_spec_top %>%
  tidyr::expand(
    tidyr::nesting(model, algo),
    date = seq(min(release), to = as.Date("2020-12-31"), by = 1)
  ) %>%
  dplyr::left_join(
    asic_spec_top,
    by = c("model", "algo", "date" = "release")
  ) %>%
  dplyr::group_by(model) %>%
  tidyr::fill(dplyr::everything(), .direction = "down") %>%
  dplyr::ungroup()
```
```{r}
# plot number of available asic machines
asic_algo_date_top  %>%
  dplyr::group_by(algo, date) %>%
  dplyr::summarise(number = sum(!is.na(hash_rate_spec))) %>%
  dplyr::ungroup() %>%
  ggplot(
    aes(
      x = date,
      y = number,
      colour = algo
    )
  ) +
  geom_line() +
  labs(
    x = "Date",
    y = "Number of available models"
  ) +
  scale_colour_viridis_d() +
  theme_classic() +
  theme(
    legend.position = "bottom"
  )
```
```{r, results = "asis"}
# plot hash_rate_spec
p <-
  asic_algo_date_top %>%
  dplyr::group_split(algo) %>%
  purrr::map(.,
    ~ dplyr::filter(., !is.na(hash_rate_spec)) %>%
      dplyr::group_by(date) %>%
      dplyr::summarise(
        min = min(hash_rate_spec, na.rm = TRUE),
        median = quantile(hash_rate_spec, 0.5, na.rm = TRUE),
        max = max(hash_rate_spec, na.rm = TRUE)
      ) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_longer(cols = c(min, median, max)) %>%
      ggplot(
        aes(
          x = date,
          y = value,
          colour = name
        )
      ) +
      geom_line() +
      labs(
        x = "Date",
        y = "Hash rate (h/s)"
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )

algo_list <-
  unique(asic_algo_date_top$algo)
for (i in 1:length(p)) {
  cat("#### ", algo_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

### scrypt currencies {.tabset}
```{r}
# average asic hash power for scrypt currencies
asic_algo_date_scrypt <-
  asic_spec_scrypt %>%
  tidyr::expand(
    tidyr::nesting(model, algo),
    date = seq(min(release), to = as.Date("2020-12-31"), by = 1)
  ) %>%
  dplyr::left_join(
    asic_spec_scrypt,
    by = c("model", "algo", "date" = "release")
  ) %>%
  dplyr::group_by(model) %>%
  tidyr::fill(dplyr::everything(), .direction = "down") %>%
  dplyr::ungroup()
```
```{r}
# plot number of available asic machines
asic_algo_date_scrypt  %>%
  dplyr::group_by(algo, date) %>%
  dplyr::summarise(number = sum(!is.na(hash_rate_spec))) %>%
  dplyr::ungroup() %>%
  ggplot(
    aes(
      x = date,
      y = number,
      colour = algo
    )
  ) +
  geom_line() +
  labs(
    x = "Date",
    y = "Number of available models"
  ) +
  scale_colour_viridis_d() +
  theme_classic() +
  theme(
    legend.position = "bottom"
  )
```
```{r, results = "asis"}
# plot hash_rate_spec
p <-
  asic_algo_date_scrypt %>%
  dplyr::group_split(algo) %>%
  purrr::map(.,
    ~ dplyr::filter(., !is.na(hash_rate_spec)) %>%
      dplyr::group_by(date) %>%
      dplyr::summarise(
        min = min(hash_rate_spec, na.rm = TRUE),
        median = quantile(hash_rate_spec, 0.5, na.rm = TRUE),
        max = max(hash_rate_spec, na.rm = TRUE)
      ) %>%
      dplyr::ungroup() %>%
      tidyr::pivot_longer(cols = c(min, median, max)) %>%
      ggplot(
        aes(
          x = date,
          y = value,
          colour = name
        )
      ) +
      geom_line() +
      labs(
        x = "Date",
        y = "Hash rate (H/s)"
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )

algo_list <-
  unique(asic_algo_date_scrypt$algo)
for (i in 1:length(p)) {
  cat("#### ", algo_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

# Algo-machine level data {.tabset}

```{r}
# make basic data
base_asic_currency_algo_date_top <- 
  make_baseline_data_asic(
    spec = asic_spec_top, 
    currency_algo_date = currency_algo_date_top,
    currency_base = currency_algo_date_top$currency[1]
  )
base_gpu_currency_algo_date_top <-
  make_baseline_data_gpu(
    spec = gpu_spec,
    currency_algo_date = currency_algo_date_top
  )
base_asic_currency_algo_date_scrypt <- 
  make_baseline_data_asic(
    spec = asic_spec_scrypt, 
    currency_algo_date = currency_algo_date_scrypt,
    currency_base = currency_algo_date_scrypt$currency[1]
  )
base_gpu_currency_algo_date_scrypt <-
  make_baseline_data_gpu(
    spec = gpu_spec,
    currency_algo_date = currency_algo_date_scrypt
  )

# merge asic and gpu
basic_currency_algo_date_top <-
  dplyr::bind_rows(
    base_asic_currency_algo_date_top,
    base_gpu_currency_algo_date_top
  )
basic_currency_algo_date_scrypt <-
  dplyr::bind_rows(
    base_asic_currency_algo_date_scrypt,
    base_gpu_currency_algo_date_scrypt
  )
```

## Top {.tabset}

```{r, results = "asis"}
# initial estimate of machine installment 
p <-
  basic_currency_algo_date_top %>%
  dplyr::group_split(algo) %>%
  purrr::map(.,
    ~ dplyr::group_by(., date) %>%
      dplyr::summarise(
        hash_rate = sum(hash_rate),
        hash_rate_spec_max = max(hash_rate_spec),
        hash_rate_spec_mean = mean(hash_rate_spec)
      ) %>%
      dplyr::ungroup() %>%
      dplyr::mutate(
        q_guess_by_max = hash_rate / (1e+6 * hash_rate_spec_max),
        q_guess_by_mean = hash_rate /(1e+6 * hash_rate_spec_mean)
      ) %>%
      tidyr::pivot_longer(cols = dplyr::starts_with("q_guess_by")) %>%
      ggplot(
        aes(
          x = date,
          y = value,
          colour = name
        )
      ) +
      geom_line() +
      labs(
        x = "Date",
        y = "Units (million)"
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
algo_list <-
  unique(basic_currency_algo_date_top$algo)
for (i in 1:length(p)) {
  cat("### ", algo_list[i], "\n")
  print(p[i])
  cat("\n")
}
```

## Scrypt {.tabset}

```{r, results = "asis"}
# initial estimate of machine installment 
p <-
  basic_currency_algo_date_scrypt %>%
  dplyr::group_split(algo) %>%
  purrr::map(.,
    ~ dplyr::group_by(., date) %>%
      dplyr::summarise(
        hash_rate = sum(hash_rate),
        hash_rate_spec_max = max(hash_rate_spec),
        hash_rate_spec_mean = mean(hash_rate_spec)
      ) %>%
      dplyr::ungroup() %>%
      dplyr::mutate(
        q_guess_by_max = hash_rate / (1e+6 * hash_rate_spec_max),
        q_guess_by_mean = hash_rate /(1e+6 * hash_rate_spec_mean)
      ) %>%
      tidyr::pivot_longer(cols = dplyr::starts_with("q_guess_by")) %>%
      ggplot(
        aes(
          x = date,
          y = value,
          colour = name
        )
      ) +
      geom_line() +
      labs(
        x = "Date",
        y = "Units (million)"
      ) +
      scale_colour_viridis_d() +
      theme_classic() +
      theme(
        legend.position = "bottom"
      )
  )
algo_list <-
  unique(basic_currency_algo_date_scrypt$algo)
for (i in 1:length(p)) {
  cat("### ", algo_list[i], "\n")
  print(p[i])
  cat("\n")
}
```




























